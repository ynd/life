<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
	"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Self-organization is the magic of life</title>
	
	<script type="text/javascript" src="jquery-1.3.2.min.js"></script>
    <style type="text/css">
    	canvas { border: 1px solid black; }
    </style>
	<script type="text/javascript">
		var CELL_SIZE = 10;
		
		var EDITING = false;
		
		function onMouseMove(e) {
			var context = this.getContext("2d");
			
			var x = e.pageX - $(this).offset().left;
			var y = e.pageY - $(this).offset().top;
			
			var cellX = Math.floor(x / CELL_SIZE) * CELL_SIZE;
			var cellY = Math.floor(y / CELL_SIZE) * CELL_SIZE;
			
			DrawCell(cellX, cellY, "black");
		}
		function onMouseUp(e) {
			EDITING = false;
			$("#universe").unbind("mousemove", onMouseMove);
		}
		function onMouseDown(e) {
			EDITING = true;
					
			var context = this.getContext("2d");
			
			var x = e.pageX - $(this).offset().left;
			var y = e.pageY - $(this).offset().top;
			
			var cellX = Math.floor(x / CELL_SIZE) * CELL_SIZE;
			var cellY = Math.floor(y / CELL_SIZE) * CELL_SIZE;
			
			DrawCell(cellX, cellY, "black");
						
			$("#universe").mousemove(onMouseMove);
		}
		
		function IsLive(pixels, x, y) {
			var canvas = document.getElementById("universe");
			var offset = y * canvas.height * 4 + x * 4;
			return pixels[offset] == 0 && pixels[offset + 1] == 0 && pixels[offset + 2] == 0;
		}
		
		function DrawCell(x, y, color) {
			var context = document.getElementById("universe").getContext("2d");
			context.fillStyle = color;
			context.fillRect(x, y, CELL_SIZE, CELL_SIZE);
		}
		
		function GameLoop() {
			if (EDITING)  {
				return;
			}
			
			var canvas = document.getElementById("universe");
			var pixels = canvas.getContext("2d").getImageData(0, 0, canvas.width, canvas.height).data;
					
			for (var y = 0; y < canvas.height; y += CELL_SIZE) {
				for (var x = 0; x < canvas.width; x += CELL_SIZE) {
					var neighbours = 0;
					
					for (var j = y - CELL_SIZE; j <= y + CELL_SIZE; j += CELL_SIZE) {
						for (var i = x - CELL_SIZE; i <= x + CELL_SIZE; i += CELL_SIZE) {
							if (j < 0 || i < 0 || (j == y && i == x)) {
								continue;
							}
							
							if (IsLive(pixels, i, j)) {
								neighbours += 1;
							}
						}
					}
					
					if (IsLive(pixels, x, y)) {
						if (neighbours < 2 || neighbours > 3) {
							DrawCell(x, y, "white");
						}
					}
					else {
						if (neighbours == 3) {
							DrawCell(x, y, "black");
						}
					}
				}
			}
		}
		
		$(document).ready(function() {
			$("#universe").mouseup(onMouseUp);
			$("#universe").mousedown(onMouseDown);
			setInterval(GameLoop, 100);
		});
    </script>
	
</head>

<body>
	<center><canvas id="universe" width="600" height="600"></canvas><center>
</body>
</html>
